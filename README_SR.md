# HolestPay Payment Gateway za OpenCart 3 & 4

Sveobuhvatan modul za integraciju plaƒáanja i dostave za OpenCart koji pru≈æa punu HolestPay funkcionalnost ukljuƒçujuƒái vi≈°e naƒçina plaƒáanja, pretplate, kalkulaciju tro≈°kova dostave i upravljanje porud≈æbinama.

> **üîß Kompatibilnost sa OpenCart 3**: Ovaj ekstenzija ukljuƒçuje posebne kompatibilne fajlove za OpenCart 3.x. Ako koristite OpenCart 3 i ekstenzija se ne pojavljuje u Extensions > Payments, pogledajte [Vodiƒç za instalaciju OpenCart 3](#opencart-3-instalacija) ispod.

## Funkcionalnosti

### Obrada plaƒáanja
- **Vi≈°e naƒçina plaƒáanja**: Podr≈°ka za sve HolestPay naƒçine plaƒáanja kao zasebne opcije
- **Podr≈°ka za pretplate**: Ponavljajuƒáa plaƒáanja sa MIT (Merchant Initiated Transactions) i COF (Card on File)
- **Upravljanje Vault tokenima**: ƒåuvanje i ponovno kori≈°ƒáenje naƒçina plaƒáanja za br≈æe finalizovanje kupovine
- **Potpisivanje zahteva**: Sigurna komunikacija sa digitalnim potpisima
- **Obraƒëivanje u realnom vremenu**: Trenutna obrada plaƒáanja i a≈æuriranje statusa

### Integracija dostave
- **Vi≈°e naƒçina dostave**: HolestPay naƒçini dostave sa kalkulacijom tro≈°kova u realnom vremenu
- **Dinamiƒçko cenovni≈°tvo**: Kalkulacija tro≈°kova na osnovu te≈æine, dimenzija i destinacije
- **Dostava po zonama**: Razliƒçite cene za domaƒáu i meƒëunarodnu dostavu

### Admin funkcionalnosti
- **Upravljanje porud≈æbinama**: Kompletno HolestPay komandno suƒçelje u detaljima porud≈æbine
- **Upravljanje konfiguracijom**: Automatska sinhronizacija konfiguracije preko webhook-ova
- **Praƒáenje statusa**: Praƒáenje statusa porud≈æbina i plaƒáanja u realnom vremenu
- **Webhook integracija**: Automatska a≈æuriranja porud≈æbina iz HolestPay sistema

### Tehniƒçke funkcionalnosti
- **Kompatibilnost sa OpenCart 3 & 4**: Jedan kod radi sa oba verzije koristeƒái automatsko prepoznavanje verzije
- **Multi-okru≈æenje**: Podr≈°ka za Sandbox i Production okru≈æenje
- **Webhook obrada**: Rukovanje konfiguracijom, a≈æuriranjima porud≈æbina i rezultatima plaƒáanja
- **Integracija baze podataka**: Prilagoƒëene tabele za ƒçuvanje HolestPay podataka
- **JavaScript integracija**: Admin i frontend JavaScript objekti
- **Automatska kompatibilnost**: Prepoznaje verziju OpenCart-a i uƒçitava odgovarajuƒáe kontroler fajlove

## Instalacija

### Preduslovi
- OpenCart 3.0.0.0 ili vi≈°e (podr≈æane su OpenCart 3.x i 4.x verzije)
- PHP 7.4 ili vi≈°e
- Potrebne PHP ekstenzije: curl, json, openssl
- SSL sertifikat (preporuƒçeno za produkciju)

### Za OpenCart 4.x

#### Automatska instalacija (preporuƒçeno)
1. Preuzmite `holestpay.ocmod.zip` paket
2. Idite na Extensions ‚Üí Installer u va≈°em OpenCart admin-u
3. Upload-ujte zip fajl
4. Idite na Extensions ‚Üí Extensions ‚Üí Payments
5. Pronaƒëite "HolestPay Payment Gateway" i kliknite Install
6. Kliknite Edit da konfiguri≈°ete modul

#### Manualna instalacija
1. Ekstraktujte zip fajl
2. Upload-ujte fajlove u va≈° OpenCart direktorijum zadr≈æavajuƒái strukturu foldera
3. Idite na Extensions ‚Üí Extensions ‚Üí Payments
4. Pronaƒëite "HolestPay Payment Gateway" i kliknite Install

## OpenCart 3 Instalacija

> **‚ö†Ô∏è Va≈æno**: OpenCart 3 koristi drugaƒçiju strukturu kontrolera od OpenCart 4. Ova ekstenzija ukljuƒçuje posebne kompatibilne fajlove za rad sa oba verzije.

### Za≈°to OpenCart 3 treba posebne fajlove?

OpenCart 3 i 4 imaju razliƒçite strukture kontrolera:
- **OpenCart 3**: Koristi strukturu baziranu na klasama (`ControllerPaymentHolestpay`)
- **OpenCart 4**: Koristi strukturu baziranu na namespace-ovima (`Opencart\Admin\Controller\Payment\Holestpay`)

Ova ekstenzija ukljuƒçuje oba verzije i automatski prepoznaje koji da koristi.

### Brza instalacija (preporuƒçeno)

1. **Preuzmite** `holestpay.ocmod.zip` paket
2. **Upload-ujte** sve fajlove u va≈° OpenCart direktorijum
3. **Pokrenite skript za kompatibilnost**:
   ```bash
   cd /putanja/do/vas/opencart/
   php fix_opencart3_compatibility.php
   ```
4. **Idite u admin panel** ‚Üí Extensions ‚Üí Extensions ‚Üí Payments
5. **Pronaƒëite "HolestPay"** i kliknite Install
6. **Kliknite Edit** da konfiguri≈°ete va≈°e postavke

### Manualna instalacija

Ako automatski skript ne radi:

1. **Ekstraktujte** zip fajl
2. **Upload-ujte** sve fajlove u va≈° OpenCart direktorijum
3. **Kopirajte kompatibilne fajlove za OpenCart 3**:
   ```bash
   # Kopirajte admin fajlove
   cp admin/controller/payment/holestpay_opencart3.php admin/controller/payment/holestpay.php
   cp admin/model/payment/holestpay_opencart3.php admin/model/payment/holestpay.php
   
   # Kopirajte catalog fajlove
   cp catalog/controller/payment/holestpay_opencart3.php catalog/controller/payment/holestpay.php
   ```
4. **Idite u admin panel** ‚Üí Extensions ‚Üí Extensions ‚Üí Payments
5. **Pronaƒëite "HolestPay"** i kliknite Install

### Re≈°avanje problema

**Problem**: Ekstenzija se ne pojavljuje u Extensions > Payments

**Re≈°enja**:
1. **Proverite dozvole fajlova**:
   ```bash
   chmod 755 admin/controller/payment/
   chmod 644 admin/controller/payment/holestpay.php
   chmod 755 admin/model/payment/
   chmod 644 admin/model/payment/holestpay.php
   chmod 755 catalog/controller/payment/
   chmod 644 catalog/controller/payment/holestpay.php
   ```

2. **Oƒçistite OpenCart ke≈°**:
   - Idite na Dashboard ‚Üí Gear Icon ‚Üí Developer Settings
   - Kliknite "Refresh" za oba Theme i SASS ke≈°-a

3. **Proverite error log-ove**:
   - Idite na System ‚Üí Maintenance ‚Üí Error Logs
   - Tra≈æite bilo kakve HolestPay povezane gre≈°ke

4. **Proverite da fajlovi postoje**:
   ```bash
   ls -la admin/controller/payment/holestpay.php
   ls -la admin/model/payment/holestpay.php
   ls -la catalog/controller/payment/holestpay.php
   ```

### Fajlovi ukljuƒçeni za OpenCart 3

- `admin/controller/payment/holestpay_opencart3.php` - OpenCart 3 admin kontroler
- `admin/model/payment/holestpay_opencart3.php` - OpenCart 3 admin model
- `catalog/controller/payment/holestpay_opencart3.php` - OpenCart 3 catalog kontroler
- `fix_opencart3_compatibility.php` - Automatski skript za kompatibilnost
- `OPENCART3_INSTALLATION.md` - Detaljni vodiƒç za instalaciju

Za detaljno re≈°avanje problema, pogledajte [OPENCART3_INSTALLATION.md](OPENCART3_INSTALLATION.md).

## Konfiguracija

### Potrebne postavke
1. **Okru≈æenje**: Izaberite Sandbox za testiranje ili Production za live transakcije
2. **Merchant Site UID**: Va≈° jedinstveni identifikator koji je dao HolestPay
3. **Secret Key**: Va≈° tajni kljuƒç za sigurnu komunikaciju

### Opcione postavke
1. **Naziv**: Naziv koji se prikazuje na checkout stranici
2. **Opis**: Opis koji se prikazuje na checkout stranici
3. **Sortiranje**: Redosled prikaza u listi naƒçina plaƒáanja
4. **Geo zona**: Ograniƒçite dostupnost na odreƒëene geografske zone
5. **Status porud≈æbine**: Status porud≈æbine nakon uspe≈°nog plaƒáanja
6. **Status neuspe≈°nog plaƒáanja**: Status porud≈æbine nakon neuspe≈°nog plaƒáanja

## Webhook konfiguracija

### Postavljanje webhook-a u HolestPay panelu

1. **Idite u HolestPay admin panel**
2. **Idite na Settings ‚Üí Webhooks**
3. **Dodajte novi webhook** sa sledeƒáim URL-om:
   ```
   https://yourdomain.com/index.php?route=extension/holestpay/payment/holestpay
   ```
4. **Izaberite topike**:
   - `posconfig-updated` - za a≈æuriranje konfiguracije
   - `orderupdate` - za a≈æuriranje porud≈æbina
   - `payresult` - za rezultate plaƒáanja

### Testiranje webhook-a

```bash
# Test webhook endpoint-a
curl -X POST https://yourdomain.com/index.php?route=extension/holestpay/payment/holestpay \
  -H "Content-Type: application/json" \
  -d '{"test": "webhook"}'
```

## API integracija

### HolestPay API pozivi

```php
// Primer API poziva
$hpay_request = array(
    "merchant_site_uid" => "your-merchant-site-uid",
    "order_uid" => "12345",
    "order_name" => "#12345",
    "order_amount" => 199.99,
    "order_currency" => "USD",
    "order_items" => array(
        array(
            "name" => "Product Name",
            "quantity" => 1,
            "price" => 199.99,
            "total" => 199.99
        )
    ),
    "order_billing" => array(
        "email" => "customer@example.com",
        "first_name" => "John",
        "last_name" => "Doe"
    ),
    "verificationhash" => "generated_signature"
);
```

### Webhook obrada

```php
// Primer webhook obrade
if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $input = json_decode(file_get_contents('php://input'), true);
    
    if (isset($input['topic'])) {
        switch ($input['topic']) {
            case 'posconfig-updated':
                // A≈æuriraj konfiguraciju
                break;
            case 'orderupdate':
                // A≈æuriraj porud≈æbinu
                break;
            case 'payresult':
                // Obraƒëuj rezultat plaƒáanja
                break;
        }
    }
}
```

## Re≈°avanje problema

### Problemi specifiƒçni za OpenCart 3

**P: Ekstenzija se ne pojavljuje u Extensions > Payments na OpenCart 3**
O: Ovo je najƒçe≈°ƒái problem. Re≈°enje je kopiranje kompatibilnih fajlova za OpenCart 3:
```bash
# Pokrenite automatski skript za popravku
php fix_opencart3_compatibility.php

# ILI ruƒçno kopirajte fajlove
cp admin/controller/payment/holestpay_opencart3.php admin/controller/payment/holestpay.php
cp admin/model/payment/holestpay_opencart3.php admin/model/payment/holestpay.php
cp catalog/controller/payment/holestpay_opencart3.php catalog/controller/payment/holestpay.php
```

**P: "Class not found" gre≈°ke na OpenCart 3**
O: Ovo znaƒçi da se koriste pogre≈°ni kontroler fajlovi. Proverite da ste kopirali `*_opencart3.php` fajlove na standardne lokacije.

**P: Ekstenzija se instalira ali ne radi pravilno na OpenCart 3**
O: Proverite da su sva tri fajla kopirana:
- `admin/controller/payment/holestpay.php` (kopiran iz holestpay_opencart3.php)
- `admin/model/payment/holestpay.php` (kopiran iz holestpay_opencart3.php)
- `catalog/controller/payment/holestpay.php` (kopiran iz holestpay_opencart3.php)

### Op≈°ti problemi

**Naƒçini plaƒáanja se ne prikazuju**
- Proverite da li je webhook konfiguracija ispravna
- Proverite da li je HolestPay poslao konfiguraciju
- Proverite tabelu baze podataka `holestpay_payment_methods`

**Tro≈°kovi dostave se ne kalkuli≈°u**
- Proverite da li su naƒçini dostave konfigurisani u HolestPay-u
- Proverite da li su te≈æina i dimenzije korpe postavljene
- Proverite konfiguraciju naƒçina dostave

**Webhook ne prima podatke**
- Proverite da li je webhook URL dostupan
- Proverite server log-ove za gre≈°ke
- Potvrdite da potvrƒëivanje potpisa radi

## Debugging

Omoguƒáite debug logovanje dodavanjem u va≈°e config fajlove:
```php
define('HOLESTPAY_DEBUG', true);
```

Proverite log-ove u:
- `system/storage/logs/holestpay.log`
- Server error log-ovi
- Browser developer console

## Brza referenca

### Korisnici OpenCart 3
- **Problem**: Ekstenzija nije vidljiva u Extensions > Payments
- **Re≈°enje**: Pokrenite `php fix_opencart3_compatibility.php`
- **Fajlovi**: Koristite `*_opencart3.php` fajlove za OpenCart 3

### Korisnici OpenCart 4
- **Instalacija**: Standardni ekstenzija installer radi
- **Fajlovi**: Automatski koristi kontrolere bazirane na namespace-ovima

### Struktura fajlova
```
holestpay-opencart/
‚îú‚îÄ‚îÄ admin/
‚îÇ   ‚îú‚îÄ‚îÄ controller/payment/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ holestpay.php              # OpenCart 4 kontroler
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ holestpay_opencart3.php    # OpenCart 3 kontroler
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ holestpay_compatibility.php # Prepoznavanje verzije
‚îÇ   ‚îî‚îÄ‚îÄ model/payment/
‚îÇ       ‚îú‚îÄ‚îÄ holestpay.php              # OpenCart 4 model
‚îÇ       ‚îî‚îÄ‚îÄ holestpay_opencart3.php    # OpenCart 3 model
‚îú‚îÄ‚îÄ catalog/
‚îÇ   ‚îî‚îÄ‚îÄ controller/payment/
‚îÇ       ‚îú‚îÄ‚îÄ holestpay.php              # OpenCart 4 kontroler
‚îÇ       ‚îú‚îÄ‚îÄ holestpay_opencart3.php    # OpenCart 3 kontroler
‚îÇ       ‚îî‚îÄ‚îÄ holestpay_compatibility.php # Prepoznavanje verzije
‚îú‚îÄ‚îÄ fix_opencart3_compatibility.php    # OpenCart 3 skript za popravku
‚îú‚îÄ‚îÄ OPENCART3_INSTALLATION.md          # Detaljni vodiƒç za OpenCart 3
‚îî‚îÄ‚îÄ README.md                          # Ovaj fajl
```

## Podr≈°ka

- **Email**: support@pay.holest.com
- **Website**: https://pay.holest.com/support
- **Dokumentacija**: https://docs.pay.holest.com/opencart
- **Problemi sa OpenCart 3**: Pogledajte [OPENCART3_INSTALLATION.md](OPENCART3_INSTALLATION.md)

## Licenca

Ovaj modul je licenciran pod komercijalnom licencom. Molimo kontaktirajte HolestPay za uslove licenciranja.

## Changelog

### Verzija 1.0.0 (2024-12-19)
- Poƒçetno izdanje
- Kompletna HolestPay integracija plaƒáanja
- Podr≈°ka za vi≈°e naƒçina plaƒáanja
- Naƒçini dostave sa kalkulacijom tro≈°kova
- Pretplate i ponavljajuƒáa plaƒáanja
- Upravljanje Vault tokenima
- Webhook integracija
- Admin upravljanje porud≈æbinama
- Kompatibilnost sa OpenCart 3 & 4
